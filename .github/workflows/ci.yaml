---
    name: Sustainability CI
    
    on:
      pull_request:
        branches:
          - "[0-9]+.0*"
      workflow_call:
      push:
    
    jobs:
      pre-commit:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - name: Checkout repository
            uses: actions/setup-python@v4
            with:
                python-version: "3.10"
                architecture: 'x64'
          - name: Get python version
            run: echo "PY=$(python -VV | sha256sum | cut -d' ' -f1)" >> $GITHUB_ENV
          - uses: actions/cache@v1
            with:
              path: ~/.cache/pre-commit
              key: pre-commit|${{ env.PY }}|${{ hashFiles('.pre-commit-config.yaml') }}
          - name: Install pre-commit
            run: pip install pre-commit
          - name: Run pre-commit
            run: pre-commit run --all-files --show-diff-on-failure --color=always
          - name: Check that all files generated by pre-commit are in git
            run: |
              newfiles="$(git ls-files --others --exclude-from=.gitignore)"
              if [ "$newfiles" != "" ] ; then
                  echo "Please check-in the following files:"
                  echo "$newfiles"
                  exit 1
              fi
      test:
        runs-on: ubuntu-22.04
        container: ghcr.io/oca/oca-ci/py3.10-odoo17.0:latest
        name: Test module ${{ matrix.INCLUDE }}
        strategy:
          fail-fast: false
          matrix:
             INCLUDE:
               - sustainability
               - sustainability_account_accountant
               - sustainability_account_asset
               - sustainability_account_asset_management
               - sustainability_employee_commuting
               - sustainability_hr_expense_report
               - sustainability_mis_builder
               - sustainability_purchase
        env:
          INCLUDE: ${{ matrix.INCLUDE }}
        services:
          postgres:
            image: postgres:16.0
            env:
              POSTGRES_USER: odoo
              POSTGRES_PASSWORD: odoo
              POSTGRES_DB: odoo
            ports:
              - 5432:5432
        steps:
          - uses: actions/checkout@v3
            with:
              persist-credentials: false
          - name: Install addons and dependencies
            run: oca_install_addons
          - name: Check licenses
            run: manifestoo -d . check-licenses
          - name: Check development status
            run: manifestoo -d . check-dev-status --default-dev-status=Beta
          - name: Initialize test db
            run: oca_init_test_database
          - name: Run tests
            run: oca_run_tests
